$(()=>{$("#chat_header").offset({top:$("nav").outerHeight()}),$("#chat_scroll").innerHeight($(window).height()-$("nav").outerHeight()-$("#chat_header").outerHeight()-$("#chat_footer").outerHeight());let is_getting_text=!1,is_checked_latest=!1,oldest_display_chat_text_id=1,new_height=0,rows=1;const footer_height_default=$("#chat_footer").outerHeight(),chat_text_line_height=$("#chat_text").css("line-height").replace(/[^0-9.]/g,"");function getNewChatLog(){is_getting_text=!0;let old_height=$("#chat_log").innerHeight();$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$.ajax({url:"/chat/"+chat_room_id+"/getNewChatLogJson",type:"GET"}).done(room=>{if(room.chat_texts.length>0){is_checked_latest&&($("#bookmark").remove(),displayBookmark());let my_text=!1,is_scroll_bottom=$("nav").outerHeight()+$("#chat_header").outerHeight()+$("#chat_footer").outerHeight()+$("#chat_scroll").get(0).scrollHeight-$("#chat_scroll").scrollTop()-$(window).height()<=10;$.map(room.chat_texts,(val,index)=>{$("#chat_log").append(formChatText(val,index)),val.user_id==auth_user_id&&(my_text=!0)});let difference=$("#chat_log").innerHeight()-old_height;new_height+=difference,my_text||is_scroll_bottom?$("#chat_scroll").animate({scrollTop:$("#chat_scroll").get(0).scrollHeight},500,"swing"):$("#new").show(),is_checked_latest=!1}}).fail(()=>{$("#error_message").text("メッセージの受信に失敗しました。"),$("#error").show()}).always(()=>{is_getting_text=!1})}function getOldChatLog(){let old_height=$("#chat_log").innerHeight();$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$.ajax({url:"/chat/"+chat_room_id+"/"+oldest_display_chat_text_id+"/getOldChatLogJson",type:"GET"}).done(room=>{if(room.chat_texts.length>0){$.map(room.chat_texts,(val,index)=>{$("#chat_log").prepend(formChatText(val,index)),oldest_display_chat_text_id=val.id});let difference=$("#chat_log").innerHeight()-old_height;$("#chat_scroll").scrollTop(difference)}}).fail(()=>{$("#error_message").text("メッセージの受信に失敗しました。"),$("#error").show()})}function submitText(){let chat_text=$("#chat_text").val();if(chat_text.length<1)return!1;$("#submit").prop("disabled",!0),$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$.ajax({type:"post",url:"/chat/"+chat_room_id+"/storeChatJson",dataType:"json",data:{chat_text:chat_text}}).then(json=>{json.error?($("#error_message").text(json.error),$("#error").show()):($("#chat_text").val(""),changeHeights(),getNewChatLog())}).fail(()=>{$("#error_message").text("送信に失敗しました。"),$("#error").show()}).always(()=>{$("#submit").prop("disabled",!1)})}function formChatText(val,index){let name_css="";return name_css=val.user_id==auth_user_id?"text-success font-weight-bold":1==val.user.user_type_id?"text-danger font-weight-bold":"text-primary font-weight-bold",`\n            <div class="chat_individual">\n                <div class="chat_header">\n                    <span class="${name_css}">${val.user.name}</span>　${moment(val.created_at,"YYYY-MM-DD hh:mm:ss").locale("ja").format("llll")}\n                </div>\n                    \n                <div class="chat_text">${val.chat_text}</div>\n            </div>\n        `}function displayBookmark(){let html='\n                <div id="bookmark" class="bg-success text-center">\n                    <span class="text-light">新着</span>\n                </div>\n                ';$("#chat_log").append(html)}function changeHeights(){let new_rows=$("#chat_text").val().split("\n").length;new_rows>maxRows()&&(new_rows=maxRows());let rows_difference=new_rows-rows;if(0!==rows_difference){let scrollTop=$("#chat_scroll").scrollTop(),is_scroll_bottom=$("nav").outerHeight()+$("#chat_header").outerHeight()+$("#chat_footer").outerHeight()+$("#chat_scroll").get(0).scrollHeight-scrollTop-$(window).height()<=10,height_difference=chat_text_line_height*rows_difference,chat_text_height=$("#chat_text").innerHeight(),chat_footer_height=$("#chat_footer").innerHeight(),to_bottom_bottom=$("#to_bottom").css("bottom");$("#chat_text").innerHeight(chat_text_height+height_difference),$("#chat_footer").innerHeight(chat_footer_height+height_difference),$("#to_bottom").css({bottom:to_bottom_bottom+height_difference}),$("#new").css({bottom:to_bottom_bottom+height_difference}),$("#error").css({bottom:to_bottom_bottom+height_difference}),$("#chat_scroll").innerHeight($(window).height()-$("nav").outerHeight()-$("#chat_header").outerHeight()-$("#chat_footer").outerHeight()),is_scroll_bottom&&$("#chat_scroll").scrollTop(scrollTop+height_difference),rows=new_rows}}function maxRows(){let maxRows=1;for(;$(window).height()/2>footer_height_default+$("#chat_text").css("line-height").replace(/[^0-9.]/g,"")*(maxRows-1);)maxRows++;return maxRows}$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$.ajax({url:"/chat/"+chat_room_id+"/getChatLogJson",type:"GET"}).done(room=>{let room_title="";room_title=room.user_id&&1!==auth_user_type_id?chat_room_office_name+" 職員":room.room_title,$("#room_name").text(room_title),$("#chat_text").prop("placeholder",room_title+"にメッセージ送信"),$("#chat_log").empty(),$.map(room.chat_texts.reverse(),(val,index)=>{$("#chat_log").append(formChatText(val,index)),val.id==room.newest_read_chat_text_id&&displayBookmark()}),oldest_display_chat_text_id=room.oldest_display_chat_text_id,$(`#chat_room[${chat_room_id}]`).removeClass("text-danger"),$("#bookmark").length?$("#chat_scroll").scrollTop($("#bookmark").offset().top-$("nav").outerHeight()-$("#chat_header").outerHeight()):$("#chat_scroll").scrollTop($("#chat_scroll").get(0).scrollHeight)}).fail(()=>{$("#error_message").text("メッセージの受信に失敗しました。"),$("#error").show()}),setInterval(()=>{is_getting_text||getNewChatLog()},1e4),$("#submit").on("click",()=>{submitText()}),$(window).on("keydown",event=>{if(!$("#submit").prop("disabled")&&event.shiftKey&&"Enter"===event.key)return submitText(),!1}),$(window).on("resize",()=>{$("#chat_scroll").innerHeight($(window).height()-$("nav").outerHeight()-$("#chat_header").outerHeight()-$("#chat_footer").outerHeight()),changeHeights()}),$("#chat_text").on("change keyup keydown paste cut",()=>{$("#error").hide(),changeHeights()}),$("#chat_scroll").on("scroll",()=>{$("nav").outerHeight()+$("#chat_header").outerHeight()+$("#chat_footer").outerHeight()+$("#chat_scroll").get(0).scrollHeight-$("#chat_scroll").scrollTop()-$(window).height()<=10&&($("#new").hide(),is_checked_latest=!0,new_height=0),0==$("#chat_scroll").scrollTop()&&getOldChatLog()}),$("#to_bottom_button").on("click",()=>{$("#chat_scroll").animate({scrollTop:$("#chat_scroll").get(0).scrollHeight},500,"swing")}),$("#new").on("click",()=>{$("#chat_scroll").animate({scrollTop:$("#chat_scroll").get(0).scrollHeight-$("#bookmark").outerHeight()-new_height},500,"swing")})});