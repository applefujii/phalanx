$(()=>{$("#chat_header").offset({top:$("nav").outerHeight()}),$("#chat_scroll").innerHeight($(window).height()-$("nav").outerHeight()-$("#chat_header").outerHeight()-$("#chat_footer").outerHeight());let is_getting_text=!1,is_checked_latest=!1,oldest_display_chat_text_id=1;function getNewChatLog(){is_getting_text=!0,$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$.ajax({url:"/chat/"+chat_room_id+"/getNewChatLogJson",type:"GET"}).done(room=>{if(room.chat_texts.length>0){is_checked_latest&&($("#bookmark").remove(),displayBookmark());let my_text=!1,is_scroll_bottom=$("nav").outerHeight()+$("#chat_header").outerHeight()+$("#chat_footer").outerHeight()+$("#chat_scroll").get(0).scrollHeight-$("#chat_scroll").scrollTop()-$(window).height()<=10;$.map(room.chat_texts,(val,index)=>{$("#chat_log").append(formChatText(val,index)),val.user_id==auth_user_id&&(my_text=!0)}),my_text||is_scroll_bottom?$("#chat_scroll").animate({scrollTop:$("#chat_scroll").get(0).scrollHeight},500,"swing"):$("#new").show(),is_checked_latest=!1}}).fail(()=>{$("#error").text("メッセージの受信に失敗しました。"),$("#error").show()}).always(()=>{is_getting_text=!1})}function getOldChatLog(){let old_height=$("#chat_log").innerHeight();$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$.ajax({url:"/chat/"+chat_room_id+"/"+oldest_display_chat_text_id+"/getOldChatLogJson",type:"GET"}).done(room=>{if(room.chat_texts.length>0){$.map(room.chat_texts,(val,index)=>{$("#chat_log").prepend(formChatText(val,index)),oldest_display_chat_text_id=val.id});let difference=$("#chat_log").innerHeight()-old_height;$("#chat_scroll").scrollTop(difference)}}).fail(()=>{$("#error").text("メッセージの受信に失敗しました。"),$("#error").show()})}function submitText(){let chat_text=$("#chat_text").val();if(chat_text.length<1)return!1;$("#submit").prop("disabled",!0),$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$.ajax({type:"post",url:"/chat/"+chat_room_id+"/storeChatJson",dataType:"json",data:{chat_text:chat_text}}).then(json=>{json.error?($("#error").text(json.error),$("#error").show()):($("#chat_text").val(""),getNewChatLog())}).fail(()=>{$("#error").text("送信に失敗しました。"),$("#error").show()}).always(()=>{$("#submit").prop("disabled",!1)})}function formChatText(val,index){let name_css="";return name_css=val.user_id==auth_user_id?"text-primary font-weight-bold":1==val.user.user_type_id?"text-danger font-weight-bold":"text-success font-weight-bold",`\n            <div class="chat_individual">\n                <div class="chat_header">\n                    <span class="${name_css}">${val.user.name}</span>　${moment(val.created_at,"YYYY-MM-DD hh:mm:ss").locale("ja").format("llll")}\n                </div>\n                    \n                <div class="chat_text">${val.chat_text}</div>\n            </div>\n        `}function displayBookmark(){let html='\n                <div id="bookmark" class="border border-success text-center">\n                    <span class="text-success">新着</span>\n                </div>\n                ';$("#chat_log").append(html)}$("#new").hide(),$("#error").hide(),$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$.ajax({url:"/chat/"+chat_room_id+"/getChatLogJson",type:"GET"}).done(room=>{let room_title="";room_title=room.user_id&&1!==auth_user_type_id?auth_office_name+" 職員":room.room_title,$("#room_name").text(room_title),$("#chat_text").prop("placeholder",room_title+"にメッセージ送信"),$("#chat_log").empty(),$.map(room.chat_texts.reverse(),(val,index)=>{$("#chat_log").append(formChatText(val,index)),val.id==room.newest_read_chat_text_id&&displayBookmark()}),oldest_display_chat_text_id=room.oldest_display_chat_text_id,$("#bookmark").length?$("#chat_scroll").scrollTop($("#bookmark").offset().top-$("nav").outerHeight()-$("#chat_header").outerHeight()):$("#chat_scroll").scrollTop($("#chat_scroll").get(0).scrollHeight)}).fail(()=>{$("#error").text("メッセージの受信に失敗しました。"),$("#error").show()}),setInterval(()=>{is_getting_text||getNewChatLog()},1e4),$("#submit").on("click",()=>{submitText()}),$(window).on("keydown",event=>{if(!$("#submit").prop("disabled")&&event.shiftKey&&"Enter"===event.key)return submitText(),!1}),$(window).on("resize",()=>{$("#chat_scroll").innerHeight($(window).height()-$("nav").outerHeight()-$("#chat_header").outerHeight()-$("#chat_footer").outerHeight())}),$("#footer_button_close").hide(),$("#footer_button_open").on("click",()=>{$("#chat_footer").outerHeight(180),$("#chat_text").prop("rows",5),$("#footer_button_close").show(),$("#footer_button_open").hide(),$("#chat_scroll").innerHeight($(window).height()-$("nav").outerHeight()-$("#chat_header").outerHeight()-$("#chat_footer").outerHeight());let scrollTop=$("#chat_scroll").scrollTop();$("#chat_scroll").scrollTop(scrollTop+100),$("#to_bottom").css({bottom:180})}),$("#footer_button_close").on("click",()=>{$("#chat_footer").outerHeight(80),$("#chat_text").prop("rows",1),$("#footer_button_open").show(),$("#footer_button_close").hide(),$("#chat_scroll").innerHeight($(window).height()-$("nav").outerHeight()-$("#chat_header").outerHeight()-$("#chat_footer").outerHeight());let scrollTop=$("#chat_scroll").scrollTop();$("#chat_scroll").scrollTop(scrollTop+100),$("#to_bottom").css({bottom:80})}),$("#chat_text").on("keydown",()=>{$("#error").hide()}),$("#chat_scroll").on("scroll",()=>{$("nav").outerHeight()+$("#chat_header").outerHeight()+$("#chat_footer").outerHeight()+$("#chat_scroll").get(0).scrollHeight-$("#chat_scroll").scrollTop()-$(window).height()<=10&&($("#new").hide(),is_checked_latest=!0),0==$("#chat_scroll").scrollTop()&&getOldChatLog()}),$("#to_bottom_button").on("click",()=>{$("#chat_scroll").animate({scrollTop:$("#chat_scroll").get(0).scrollHeight},500,"swing")})});